# 应用层小论文
[TOC]



## 小组名单

| 姓名   | 学号          | 工作内容 |
| :--- | :---------- | ---- |
| 欧作松  | 14030110087 | 协议论文 |
| 付林   |             |      |
| 李杉   |             |      |
## 应用层协议概述

### 应用层协议的作用

应用层协议定义运行在不同端系统上的应用程序进程如何彼此传递消息，具体地说，一个应用层协议定义三个方面：

1. 所传递的消息类型。


1. 各种消息的语法，即消息中所能包含的字段及字段的格式和意义。
2. 确定一个进程何时以及如何发出消息或响应所收到消息的规则。

### 聊天系统的实现方案

#### 通讯方式

采用**服务器中转**方式：两个移动设备之间的收发消息都需要服务器进行中转并做消息的转发。

![2017-04-23 10-29-56屏幕截图](/home/ouzuosong/Documents/网络计算/2017-04-23 10-29-56屏幕截图.png)

整个IM流程中，服务器接收消息发送方的请求，并检查接收方当前是否在线，如果在线的话则直接向接收方发送消息，如果不在线则作为离线消息存储到数据库中，等待接收方上线的时候再将消息进行发送。

#### 网络链接方式

基于**TCP的长连接**：

 IM通信实现的基础是需要时时刻刻保持客户端在服务器上的在线状态，这样才能保证发送方的消息能够**及时**到接收方。有了epoll等技术后，多连接就不是瓶颈了，TCP长链接能很好的支持**大批量用户**，单机几十万链接没什么问题，并且这种方式能够保证下行消息/指令的**及时性**，但是在弱网络下上行慢的问题还是比较严重。 

####  应用层协议设计：

应用层协议选型，常见的有三种：文本协议、二进制协议、流式XML协议。

查阅资料后发现在IM通讯领域两个著名的协议：XMPP，MQTT：

**XMPP:**

>简介：基于XML协议的通讯协议，前身是Jabber，目前已由IETF国际标准化组织完成了标准化工作。
>优点：协议成熟、强大、可扩展性强、目前主要应用于许多聊天系统中，且已有开源的Java版的开发实例androidpn。
>缺点：协议较复杂、冗余（基于XML）、费流量、费电，部署硬件成本高。

**MQTT：**

>简介：轻量级的、基于代理的“发布/订阅”模式的消息传输协议。
>优点：协议简洁、小巧、可扩展性强、省流量、省电，目前已经应用到企业领域（参考：[http://mqtt.org/software](http://mqtt.org/software)），且已有C++版的服务端组件rsmb。
>缺点：不够成熟、实现较复杂、服务端组件rsmb不开源，部署硬件成本较高。

一个实际的例子：

可采用**定长二进制包头，可扩展的二进制包体** ：包体可以使用用文本、XML等扩展性好的协议。包头负责传输和解析效率，与业务无关。包体保证扩展性，与业务相关。

服务器接收到转发消息后，不进行解释是何种类型的信息，若接收方在线则直接转发给客户端，接收方接收到消息后解析包头获取信息的类型（这里指文字、表情图标、图像信息、任意文件），再调用相应的模块解释信息并呈现给用户。

### 离线信息转发实现方式

整个IM流程中，服务器接收消息发送方的请求，并检查接收方当前是否在线，如果在线的话则直接向接收方发送消息，如果不在线则作为离线消息存储到数据库中，**等待接收方上线的时候再将消息进行发送，**并告知消息发送方此时接收方不在线。

而如何判断用户是否在线是一个问题：

运营商的设别断电或故障等、移动设别接收端本身设备断点掉线等诸多复杂的因素存在导致直接依赖于TCP的长连接方案不可行，其次例如Android操作系统本身也是会对TCP的长连接做处理，并且TCP的socket长连接是非常耗费资源的，所以在一定时间的TCP长连接闲置后，系统也会自动清除设备上的长连接。由此可引入**心跳包**的方案：就是客户端每个一会儿就要向服务器发送一个请求报文（这个报文可以是空的，跟服务器那边约定好），目的是为了告诉服务器“我是在线的”，而服务器在接收心跳请求报文之后同样需要反馈一个消息告诉客户端“我知道了”，通过应用层上的不断进行消息收发来维持长连接的存在，当客户端没有一直没有收到服务器的反馈时默认已经掉线，进行相关的业务逻辑处理后将再重连服务器，同样服务器没有收到客户端发送来的心跳包时，可以默认客户端已经掉线，将服务器上的通信socket进行关闭回收资源。并且将消息存储到数据库中，待用户上线后将消息发送出去。

## 应用层协议数据结构

### 分析协议内容

### 数据包结构以及各组成作用

**数据包的整体结构以及作用：**

两协议中数据包都分为包头和包体部分，其中包头部分是固定的，是所有数据包的必要部分，标识数据包的长度、标识操作序列号、操作的类型。包体部分具体定义各种不同操作类型包所需要参数字段。

### MO/MT业务中信息解读实现方法

信息解读通过数据包中的命令字段的标识



## 系统互联

可行。

两个不同系统间采用的都是c/s模式，即系统中两个不同设备之间通信都是客户端发起通信，与服务端建立连接，之后客户端进行相应的请求，服务器返回响应。虽然两者规定的应用层协议不一样，但是使得系统中两设备能正常通信并作出相应的相应，两个协议的数据结构中都包含了需要用到的信息的相应字段，提出以下解决方案：

1. 在每一地区设立一个**互联网关**专门用于两系统之间的互联，那么各自系统的网关不需要做太多工作，只需要将发往其他系统的数据包转发给本地的互联网关处理即可。

   **互联网关**需要实现以下功能：

   * 解析接收的数据包的各自字段。
   * 根据解析出的包中目的方字段识别出接收消息的系统。
   * 根据接收方的协议将各个字段重新封装包，并将其发送到接收方系统的网关。

2. 在每一个网关实现上述**互联网关**的功能。

## 短信网关系统框架

### 短信网关系统框架拓扑结构



![2017-04-25 16-06-25屏幕截图](/home/ouzuosong/Documents/网络计算/2017-04-25 16-06-25屏幕截图.png)

短信网关由服务提供商（SP）、短信网关、短信中心、汇接网关四部分组成。各部分功能如下：

* 务提供商（Service Provider缩写SP）：短信信息服务的信息提供者；
* 短信网关（Short Message Gateway缩写SMG）：提供SP与短信中心之间数据交换的通道。
* 短信中心（Short Message Service Center缩写SMSC）：利用信令网将短消息发送给手机用户；
* 汇接网关（Gateway Name Server缩写GNS）：提供短信网关的路由查询。

### 异地短信处理流程

1. 消息从本地SMSC到异地SP：

   SMG从本地SMSC接收短消息，再路由到异地SMG，由异地的SMG发送到目的SP，比如

   SMSC1A—〉SMG1—〉SMG2—〉SP2Y

   SMSC1B—〉SMG1—〉SMG3—〉SP3X

2. 消息从本地SP到异地SMSC;

   SMG从本地SP接收短消息，再路由到异地SMG，由异地的SMG发送到目的SMSC，比如

   SP1X—〉SMG1—〉SMG2—〉SMSC2A

   SP1Y—〉SMG1—〉SMG3—〉SMSC3B

   ​

   **数据包解读:**(以SMSC发送向异地SP请求某一服务为例)

   1. SMC1解析收到的数据包，检测数据包中SP地址字段。


   2. SMC1查询本地路由表，得到转发SMC2的地址。
   3. SMC1向SMC2发送登录请求（若未建立连接），即向SMC2发送登录数据包。
   4. SMC2向SMC1返回登录响应。
   5. SMC1封装转发数据包，将命令字段设置为转发。
   6. SMC2解析接收到的数据包的命令字段。
   7. 查询路由表，建立与本地SP的连接。

### 将西安网关并联如系统

**解决方案:**

只需要在汇接网关加入西安网关的表项目，并将路由表更新到各个区域的短信网关中。

## 总结及意见的工作总结

欧作松：通过此次应用层小论文的工作，对应用层的了解有了更深刻的认识，并深入研究了两篇不同系统的短消息网关的应用层协议，对短信信息服务的各个参与者有了一定的了解，尤其是短信网关的应用层协议设计的重要性，最后自主思考了不同系统之间的互联方案。